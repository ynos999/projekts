{% extends "base.html" %}
{% block title %}{{title }} |{{block.super}}{% endblock title %}
{% load crispy_forms_tags %}

{% block content %}

 <!-- Default box -->
 <div class="card">
    <div class="card-header">
      <!-- <h3 class="card-title">{{ project.name }}</h3> -->
       <h3 class="card-title">
          {{ project.name }}
          {% if project.owner == request.user or request.user.is_superuser %}
              <span class="ml-2">
                  <a href="{% url 'projects:update' project.pk %}" class="btn btn-xs btn-info">
                      <i class="fas fa-edit"></i> Edit
                  </a>
                  <a href="{% url 'projects:delete' project.pk %}" class="btn btn-xs btn-danger">
                      <i class="fas fa-trash"></i> Delete
                  </a>
              </span>
          {% endif %}
      </h3>

      <div class="card-tools">
        <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
          <i class="fas fa-minus"></i>
        </button>
        <button type="button" class="btn btn-tool" data-card-widget="remove" title="Remove">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-12 col-md-12 col-lg-8 order-2 order-md-1">
          <div class="row">
            <div class="col-12 col-sm-4">
              <div class="info-box bg-light">
                <div class="info-box-content">
                  <span class="info-box-text text-center text-muted">Estimated budget</span>
                  <span class="info-box-number text-center text-muted mb-0">{% if project.total_amount %}{{ project.total_amount }} {% else %}0{% endif %}</span>
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-4">
              <div class="info-box bg-light">
                <div class="info-box-content">
                  <span class="info-box-text text-center text-muted">Total amount spent</span>
                  <span class="info-box-number text-center text-muted mb-0">{% if project.amount_spent %}{{ project.amount_spent }} {% else %}0{% endif %}</span>
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-4">
              <div class="info-box bg-light">
                <div class="info-box-content">
                  <span class="info-box-text text-center text-muted">Estimated project duration</span>
                  <span class="info-box-number text-center text-muted mb-0">{% if project.estimated_duration %}{{ project.estimated_duration }} Days {% else %}0{% endif %}</span>
                </div>
              </div>
            </div>
          </div>

          <br> 
          <!-- project kanban board -->
          <a href="{% url "projects:kanban-board" project.id %}" class="btn btn-sm btn-primary">View Kanban Board</a> 
           <!-- end of project kanban board -->               
              
            <br>
            <br>

            
  <!-- comments -->      
          <div class="row">
            <div class="col-12">
              <h4>Recent Comments({{ comments_count }})</h4>
            <form action="{% url "projects:project-detail" project.pk %}" method="post">
              {% csrf_token %}
              <div class="col-10">
              {{ comment_form|crispy }}
            </div>

            {% comment %} button {% endcomment %}
            <div class="row">
              <div class="col-10">
                <input type="submit" name="comment_submit" value="post your comment" class="btn btn-success float-left">
              </div>
            </div>
            </form>
            <br>
            {% comment %} displaying messages {% endcomment %}
            {% if messages %}
            <div class="messages col-10">
              {% for message in messages %}
              <div class="alert {% if message.tags %}alert-{{message.tags}}{% else %}alert-info{% endif %}">
                {{ message }}
              </div>
              
              {% endfor %}

            </div>
            
            {% endif %}

            {% for comment in page_obj %}
            <div class="post" id="comment-{{ comment.id }}">
                <div class="user-block">
                    <img class="img-circle img-bordered-sm" src="{{ comment.user.profile.profile_picture_url }}" alt="user image">
                    <span class="username">
                        <a href="#">{{ comment.user.profile.full_name }}</a>
                        
                        {# Rādām darbību pogas tikai autoram vai adminam #}
                        {% if comment.user == request.user or request.user.is_superuser %}
                        <span class="float-right">
                            <button type="button" class="btn btn-tool" onclick="toggleEdit('{{ comment.id }}')">
                                <i class="fas fa-pencil-alt text-info"></i>
                            </button>
                            
                            <form action="{% url 'projects:delete-comment' comment.id %}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this comment?')">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-tool">
                                    <i class="fas fa-times text-danger"></i>
                                </button>
                            </form>
                        </span>
                        {% endif %}
                    </span>
                    <span class="description">Pievienots: {{ comment.created_at|timesince }} atpakaļ</span>
                </div>

                <div id="comment-text-{{ comment.id }}">
                    <p>{{ comment.comment }}</p>
                </div>

                {% if comment.user == request.user or request.user.is_superuser %}
                <div id="edit-form-{{ comment.id }}" style="display: none; margin-bottom: 15px;">
                    <form action="{% url 'projects:edit-comment' comment.id %}" method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <textarea name="comment_text" class="form-control" rows="2">{{ comment.comment }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-success">Saglabāt</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleEdit('{{ comment.id }}')">Atcelt</button>
                    </form>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <p class="text-muted">Vēl nav neviena komentāra.</p>
            {% endfor %}
            

            <!-- {% for comment in page_obj %}
                <div class="post">
                  <div class="user-block">
                    <img class="img-circle img-bordered-sm" src="{{ comment.user.profile.profile_picture_url }}" alt="user image">
                    <span class="username">
                      <a href="#">{{ comment.user.profile.full_name }}</a>
                    </span>
                    <span class="description">Shared publicly - {{ comment.created_at | timesince}}</span>
                  </div>
                  
                  <p>
                    {{ comment.comment }}
                  </p>                  
                </div>

                {% endfor %}                -->
            </div>
          </div>
        {% comment %} pagination {% endcomment %}
        {% include "components/paginator.html" %}

        </div>
        <div class="col-12 col-md-12 col-lg-4 order-1 order-md-2">
          <h3 class="text-primary"><i class="fas fa-paint-brush"></i> {{ my_company }}</h3>
          <p class="text-muted">{{ my_company_description }}</p>
          <br>
          <div class="text-muted">
            {% if project.client_company %}
            <p class="text-sm">Client Company
              <b class="d-block">{{ project.client_company }}</b>
            </p>
            {% endif %}
            <p class="text-sm">Project Leader
              <b class="d-block">{{ project.team.team_lead.profile.full_name }}</b>
            </p>
          </div>

          <h5 class="mt-5 text-muted">Project files</h5>
          <ul class="list-unstyled">
            {% for attachment in project.attachments.all %}
            <li>
              <a href="{{ attachment.file.url }}"  target="_blank"  class="btn-link text-secondary">
                <i class="far fa-fw fa-file"></i> {{ attachment.file.name|truncatechars:40 }}x</a>
            </li>
            {% endfor %}
           
          </ul>
          <div class="text-center mt-5 mb-3">
            <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#modal-default">
             Add files
            </button>
            
          </div>
        </div>
      </div>
    </div>
    <!-- /.card-body -->
  </div>
  <!-- /.card -->

  <div class="modal fade" id="modal-default">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Upload project files</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <form action="" method="post" enctype="multipart/form-data">
          {% csrf_token %}
        <div class="modal-body">
          {{ attachment_form }}
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <input type="submit" name="attachment_submit" value="Upload file" class="btn btn-primary">
        </div>
      </form>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->

{% endblock %}
{% block script %}
<script>
function toggleEdit(commentId) {
    const textDiv = document.getElementById('comment-text-' + commentId);
    const formDiv = document.getElementById('edit-form-' + commentId);

    if (formDiv.style.display === "none") {
        textDiv.style.display = "none";
        formDiv.style.display = "block";
    } else {
        textDiv.style.display = "block";
        formDiv.style.display = "none";
    }
}
</script>
{% endblock %}