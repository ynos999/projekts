{% extends "base.html" %}
{% block title %}{{title }} |{{block.super}}{% endblock title %}
{% load static %}

{% comment %} page specific css {% endcomment %}

{% block page_css %}

 <!-- Ekko Lightbox -->
 <link rel="stylesheet" href="{% static "plugins/ekko-lightbox/ekko-lightbox.css" %} ">

 <style>
  .task-card {
    cursor: grab;
  }

  .form-group {
    display: flex;
  }

  #backlog h3 {
    margin-right: 10px;
  }

 </style>
{% endblock  %}

{% block content %}

<div class="container-fluid h-100" id="board-container">

    <div class="card card-row card-secondary board-column" id="backlog" data-status="Backlog">
      <div class="card-header">
        <h3 class="card-title">
          Backlog
        </h3>

        {% comment %} Task creation form  {% endcomment %}
        <form id="create-task-form" data-project-id="{{ project.id}}" method="POST" action="{% url "tasks:create-task-ajax" %}">
          {% csrf_token %}
          <div class="form-group">
            <input type="text" id="task-name" name="name" class="form-control task-input" placeholde="New Task">
          </div>
        </form>
      </div>
      <div class="card-body task-list">

        {% for task in backlog_tasks %}
            <div class="card card-secondary card-outline task-card" data-task-id="{{ task.id}}">
            <div class="card-header">
                <h5 class="card-title">{{ task.name }}</h5>
                <div class="card-tools">
                <a href="#" class="btn btn-tool btn-link task-counter"></a>              


                <a href="#" class="btn btn-tool">
                    <i class="fas fa-pen"></i>
                </a>

                <a href="#" class="btn btn-tool">
                    <i class="fas fa-user-plus"></i>
                </a>
                {{ task.user_assigned_to.get_full_name|default:task.user_assigned_to.username }}
                {% if task.user_assigned_to %}
                  <a href="#">
                  <img src="{{ task.user_assigned_to.profile.profile_picture_url }}" height="20" width="20" class="img-circle elevation-2" alt="{{ task.user_assigned_to.profile.full_name}}">
                </a>
                {% endif %}
                </div>
            </div> 
            
            {% comment %} task description {% endcomment %}
            {% if task.description %}
             <div class="card-body">
                <p class="card-description">
                 {{ task.description }}
                </p>
              </div>            
            {% endif %}

            </div>
        {% endfor %}

     
      </div>
    </div>


    <div class="card card-row card-primary board-column" id="to-do" data-status="To Do">
      <div class="card-header">
        <h3 class="card-title">
          To Do
        </h3>
      </div>
      <div class="card-body task-list">
        {% for task in todo_tasks %}
        <div class="card card-primary card-outline task-card" data-task-id="{{ task.id}}">
          <div class="card-header">
            <h5 class="card-title">{{ task.name }}</h5>
            <div class="card-tools">
              <a href="#" class="btn btn-tool btn-link">#{{ forloop.counter }}</a>

                 <a href="#" class="btn btn-tool">
                    <i class="fas fa-pen"></i>
                </a>

                <a href="#" class="btn btn-tool">
                    <i class="fas fa-user-plus"></i>
                </a>

                {% if task.user_assigned_to %}
                  <a href="#">
                  <img src="{{ task.user_assigned_to.profile.profile_picture_url }}" height="20" width="20" class="img-circle elevation-2" alt="{{ task.user_assigned_to.profile.full_name}}">
                </a>
                {% endif %}
            </div>
          </div>

          {% comment %} task description {% endcomment %}
               {% if task.description %}
             <div class="card-body">
                <p class="card-description">
                 {{ task.description }}
                </p>
              </div>            
            {% endif %}

        </div>
        {% endfor %}
      </div>
    </div>


    <div class="card card-row card-default board-column" id="in-progress" data-status="In Progress">
      <div class="card-header bg-info">
        <h3 class="card-title">
          In Progress
        </h3>
      </div>
      <div class="card-body task-list">

        {% for task in in_progress_tasks %}
        <div class="card card-primary card-outline task-card" data-task-id="{{ task.id}}">
          <div class="card-header">
            <h5 class="card-title">{{ task.name }}</h5>
            <div class="card-tools">
              <a href="#" class="btn btn-tool btn-link">#{{ forloop.counter }}</a>

                 <a href="#" class="btn btn-tool">
                    <i class="fas fa-pen"></i>
                </a>

                <a href="#" class="btn btn-tool">
                    <i class="fas fa-user-plus"></i>
                </a>

                {% if task.user_assigned_to %}
                  <a href="#">
                  <img src="{{ task.user_assigned_to.profile.profile_picture_url }}" height="20" width="20" class="img-circle elevation-2" alt="{{ task.user_assigned_to.profile.full_name}}">
                </a>
                {% endif %}
            </div>
          </div>

          {% comment %} task description {% endcomment %}
                {% if task.description %}
             <div class="card-body">
                <p class="card-description">
                 {{ task.description }}
                </p>
              </div>            
            {% endif %}
        
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="card card-row card-success board-column" id="completed" data-status="Completed">
      <div class="card-header">
        <h3 class="card-title">
          Completed
        </h3>
      </div>
      <div class="card-body task-list">
        {% for task in completed_tasks %}
        <div class="card card-success card-outline task-card" data-task-id="{{ task.id}}">
          <div class="card-header">
            <h5 class="card-title">{{ task.name }}</h5>
            <div class="card-tools">
              <a href="#" class="btn btn-tool btn-link">#{{ forloop.counter }}</a>

                 <a href="#" class="btn btn-tool">
                    <i class="fas fa-pen"></i>
                </a>

                <a href="#" class="btn btn-tool">
                    <i class="fas fa-user-plus"></i>
                </a>

                {% if task.user_assigned_to %}
                  <a href="#">
                  <img src="{{ task.user_assigned_to.profile.profile_picture_url }}" height="20" width="20" class="img-circle elevation-2" alt="{{ task.user_assigned_to.profile.full_name}}">
                </a>
                {% endif %}
            </div>
          </div>

          {% comment %} task description {% endcomment %}
                {% if task.description %}
             <div class="card-body">
                <p class="card-description">
                 {{ task.description }}
                </p>
              </div>            
            {% endif %}

        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  {% include "tasks/task_update_modal.html" %}
   {% include "tasks/team_member_task_assignment_modal.html" %}

{% endblock  %}


{% block script %}

<script>
  document.addEventListener('DOMContentLoaded', function () {

    const taskCards = document.querySelectorAll('.task-card');
    taskCards.forEach(card => {
      card.draggable = true;

      card.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', card.dataset.taskId);
        console.log(card.dataset)
      })
    });

    const columns = document.querySelectorAll('.board-column');

    columns.forEach(column => {
      // 1. Atļaujam "dragover", lai "drop" vispār strādātu
      column.addEventListener('dragover', (e) => {
        e.preventDefault();
      });

      // 2. "Drop" notikums - jābūt ārpus dragover
      column.addEventListener('drop', (e) => {
        e.preventDefault();
        const taskId = e.dataTransfer.getData('text/plain');
        const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
        
        if (!taskCard) return;

        // Iegūstam jauno statusu no ID (piem. "to-do" -> "to do")
        const newStatus = column.id.replace('-', ' ');


        // Vizuāli pārvietojam kartīti
        const taskList = column.querySelector('.task-list');
        taskList.prepend(taskCard);

        // Atjaunojam krāsas
        taskCard.classList.remove('card-primary', 'card-secondary', 'card-light', 'card-success');
        if(column.id === 'backlog'){
          taskCard.classList.add('card-secondary');
        } else if (column.id === 'to-do' || column.id === 'in-progress'){
          taskCard.classList.add('card-primary');
        } else if (column.id === 'completed'){
          taskCard.classList.add('card-success');
        }

        // IZSAUCAM AJAX
        updateTaskStatus(taskId, newStatus);
        
        // Atjaunojam numerāciju
        updateTaskCounters();
      });
    });

function updateTaskStatus(taskId, newStatus) {
    console.log("Sūtam uz serveri:", taskId, newStatus);

    fetch(`/tasks/update-task-status-ajax/${taskId}/`, {
        method: 'POST',
        headers: {
            // Svarīgi: sūtot teksta datus, šis ir drošākais veids
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        // encodeURIComponent palīdzēs ar "to do" atstarpēm
        body: `status=${encodeURIComponent(newStatus)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log("Veiksmīgi saglabāts DB:", data.status);
        } else {
            console.error("Servera kļūda:", data.error);
        }
    })
    .catch(error => console.error("Tīkla kļūda:", error));
}

    //submitting form on enter key
    const taskForm = document.getElementById('create-task-form');
    const taskInput = document.getElementById('task-name');
    const projectId = taskForm.getAttribute('data-project-id');

    //get backlog column
    const backlogColumn = document.getElementById('backlog');

    if (taskForm && taskInput && projectId){
      taskInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          event.preventDefault();

          const taskName = taskInput.value.trim();
          if (taskName){
            const formData = new FormData(taskForm);
            formData.append('name', taskName);
            formData.append('project_id', projectId);

            fetch(taskForm.action, {
              method: taskForm.method,
              body: formData,
              headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                console.log('Task created successfully', data.task_id);
                taskInput.value = '';

                //dynamically create the new task
                const newTaskCard = document.createElement('div');
                newTaskCard.classList.add('card', 'card-secondary', 'card-outline', 'task-card');
                newTaskCard.setAttribute('data-task-id', data.task_id);
                newTaskCard.draggable = true;

                //add the task content
                newTaskCard.innerHTML = `
                <div class="card-header">
                <h5 class="card-title">${taskName}</h5>
                <div class="card-tools">
                <a href="#" class="btn btn-tool btn-link task-counter"></a>
                  <a href="#" class="btn btn-tool">
                    <i class="fas fa-user-plus"></i>
                </a>
                <a href="#" class="btn btn-tool">
                    <i class="fas fa-pen"></i>
                </a>
                </div>
            </div>  
                `;

                //append new created task to backlog column
                const backlogTaskList = backlogColumn.querySelector('.task-list');
                backlogTaskList.prepend(newTaskCard);

                //updating task counter
                updateTaskCounters();

                //add drag and drop listener to the newly created task
                newTaskCard.addEventListener('dragstart', (e) => {
                  e.dataTransfer.setData('text/plain', newTaskCard.dataset.taskId);
                });



              }else{
                console.error('Error:', data.error);
              }
            })
            .catch(error => {
              console.error('Error creating task: ', error);
            });


          }else{
            console.log('Task name is empty');
          }         

        }
      });

    }else{
      console.error('Form, input, or project ID is not found');
    }


    //function to update task counters

    function updateTaskCounters() {
      const taskCards = backlogColumn.querySelectorAll('.task-card');
      taskCards.forEach((card, index) => {
        const taskCounter =  card.querySelector('.task-counter');
        if(taskCounter){
          taskCounter.textContent = `#${index + 1}`;
        }
      });
    }

    //calling update task counter on page load
    updateTaskCounters();

    //open a modal 
    const taskUpdateModal = document.getElementById('taskUpdateModal');
    let currentTaskId = null;

  const kanbanBoard = document.getElementById('board-container');
   kanbanBoard.addEventListener("click", function(event){

    const targetIcon = event.target.closest('i');
    if (targetIcon){
      const taskCard = event.target.closest('.task-card');
      const taskId = taskCard.getAttribute("data-task-id");
      if(targetIcon.classList.contains('fa-user-plus')){
        
        //open task assignment modal
        openTeamMemberAssignmentModal(taskId)
      } else if (targetIcon.classList.contains('fa-pen')){
        //open modal here
      openTaskModal(taskId)
      }
    }  
   });

   function openTeamMemberAssignmentModal(taskId){
    fetch(`/tasks/${taskId}/assignment-form/`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.error){
        console.error(data.error);
      } else {
        document.querySelector('#taskAssignmentModal .modal-body').innerHTML = data.html;
        $('#taskAssignmentModal').modal('show');
        
        //submitting the form
        teamMemberAssignmentHandler();
      }
    })
    .catch(error => console.error('Error fetching the task assignment form:', error));
    
   }

   
   function teamMemberAssignmentHandler(){
    const assignmentForm = document.querySelector('#task-assignment-form');
    if (assignmentForm){
      assignmentForm.addEventListener('submit', function (e){
        e.preventDefault();
        const url = this.action;
        const formData = new FormData(this);
        const taskId = this.getAttribute('data-task-id');

        fetch(url, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
        })
        .then(response => response.json())
        .then(data =>{
          if(data.success){
             $('#taskAssignmentModal').modal('hide');

             //dynamically update a task card
             const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
             if (taskCard){
              const toolsDiv  = taskCard.querySelector('.card-tools');
              if(!toolsDiv){
                console.error("Tools dive does not exist");
                return;
              }

              //update or insert profiel picture 
              const existingProfileImg = taskCard.querySelector('img');
              if (existingProfileImg){
                existingProfileImg.src = data.user.profile_picture_url;

              }else{
                const imgHtml = `<a href="#">
                  <img src="${data.user.profile_picture_url}" height="20" width="20" class="img-circle elevation-2" alt="${data.user.name}">
                </a>`;

                //insert profile image in the tools div
                toolsDiv.insertAdjacentHTML('beforeend', imgHtml)
               
                
              }

             }

          }else{
            alert('error: ' + JSON.stringify(data.error));
          }
        })
        .catch(error => console.error('Error submitting the form:', error));
      });
    }else{
      console.error("Assignment form not found");
    }

   }



    //open modal
    function openTaskModal(taskId){
      currentTaskId = taskId
      //make ajax reqeust to the server
       fetch(`/tasks/${currentTaskId}/get/`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
       })
       .then(response => response.json())
       .then(data => {
        if(data.error){
          console.error('Task not found');
        } else {
          task = data.task_data;
          console.log(task.priority); // debug

          //setting data into forms fields
          taskUpdateModal.querySelector('input[name="task_id"]').value = task.task_id;
          taskUpdateModal.querySelector('input[name="name"]').value = task.name;
          taskUpdateModal.querySelector('textarea[name="description"]').value = task.description;
          taskUpdateModal.querySelector('select[name="priority"]').value = task.priority;
          taskUpdateModal.querySelector('input[name="start_date"]').value = task.start_date;
          taskUpdateModal.querySelector('input[name="due_date"]').value = task.due_date;

          //show modal
          $('#taskUpdateModal').modal('show');         
        }
       })
       .catch(error => console.error('Error fetching data:', error));
    }


    //updating task 
    const form = document.getElementById("taskUpdateForm");
    form.addEventListener("submit", function(event){
      event.preventDefault();
      const formData = new FormData(form);
      console.log(formData)

      fetch(`/tasks/${currentTaskId}/update/`, {
        method: 'POST',
        body: formData,
        headers: {
          "x-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
      })
      .then(response => response.json())
      .then(data => {
        if(data.success){
        
          //find the taskCard
          const taskCard = document.querySelector(`.task-card[data-task-id="${currentTaskId}"]`);

          //check if the card exist
          if(taskCard){
            taskCard.querySelector(".card-title").textContent = data.updatedTask.name;

            // check if card-description exist
            let descriptionElement = taskCard.querySelector(".card-description");
            if(descriptionElement){
              descriptionElement.textContent = data.updatedTask.description;
            } else if(data.updatedTask.description){
             
              const cardBody = document.createElement("div");
              cardBody.classList.add("card-body");
              descriptionElement  = document.createElement("p");
              descriptionElement.classList.add("card-description");
              descriptionElement.textContent = data.updatedTask.description;

              //append them to the card body
              cardBody.appendChild(descriptionElement);
              taskCard.appendChild(cardBody);
            }

          } else{
            console.error("Task card not found for TaskId: ", currentTaskId);
          }



           //show modal
          $('#taskUpdateModal').modal('hide');

        }else {
          console.error("Error updating taks:", data.error);
        }
      })
      .catch(error => console.error("Error", error));

      
    });






  


  });

</script>

{% endblock %}