{% extends "registration/auth_base.html" %}
{% block title %}Login | {{ block.super }}{% endblock %}
{% load crispy_forms_tags %}

{% block content %}
<div class="card-body">
  <p class="login-box-msg">Sign in to start your session</p>

  <form id="login-form" action="" method="post">
    {% csrf_token %}
    
    {# Galvenā forma - django-recaptcha automātiski ģenerēs laukus un JS #}
    {{ form|crispy }}
    
    {% if form.captcha.errors %}
      <div class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        {% for error in form.captcha.errors %}{{ error }}{% endfor %}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endif %}

    <div class="mt-4">
      <button type="submit" id="submit-btn" class="btn btn-primary btn-block shadow-sm">
        <span id="btn-text">Login</span>
        <span id="btn-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
      </button>
    </div>
  </form>

  <p class="mt-3 mb-1">
    <a href="{% url 'password_reset' %}">I forgot my password</a>
  </p>
</div>

<script>
  // Izmantojam addEventListener, lai netraucētu reCAPTCHA skriptam pabeigt darbu
  document.getElementById('login-form').addEventListener('submit', function(e) {
    const form = this;

    // Pārbaudām standarta HTML5 validāciju
    if (form.checkValidity()) {
      const btnText = document.getElementById('btn-text');
      const btnSpinner = document.getElementById('btn-spinner');
      const submitBtn = document.getElementById('submit-btn');

      // Animācijas iedarbināšana
      btnText.classList.add('invisible');
      btnSpinner.classList.remove('d-none');
      
      // Svarīgi: neizmantojam .disabled = true, lai nebloķētu Captcha datus
      // Tā vietā neļaujam klikšķināt vēlreiz vizuāli
      submitBtn.style.pointerEvents = 'none';
      submitBtn.style.opacity = '0.7';
    }
  });
</script>
{% endblock %}